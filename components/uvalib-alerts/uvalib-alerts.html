<link rel="import" href="../uvalib-theme/uvalib-ui-element.html">
<link rel="import" href="../uva-helper-libs/polyfills/object.assign.html">
<link rel="import" href="../uva-models/uva-library-alerts.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../uvalib-theme/uvalib-alerts-style.html">

<dom-module id="uvalib-alerts">
  <template>
    <custom-style>
      <style include="uvalib-theme uvalib-alerts-style">
      </style>
    </custom-style>

    <uva-library-alerts id="alertsModel" alerts="{{_alerts}}" seen-count="{{seenCount}}" seen="{{_alertsSeen}}"></uva-library-alerts>
    <dom-repeat items="[[_alerts]]" as="alert">
      <template>
        <iron-collapse opened$="[[!alert.seen]]" on-opened-changed="_sizeChanged" on-transitioning-changed="_sizeChanged">
          <div class$="alert-item [[alert.severity]]" uuid="[[alert.uuid]]">
            <div>
            <div class="alert-head">
              <div class="alert-title" on-click="_toggleIt">[[alert.title]]</div>
              <template is="dom-if" if="[[!_isHot(alert.severity)]]">
                <paper-button on-click="_toggleIt">More</paper-button>
                <paper-button on-click="_dismissIt">Dismiss</paper-button>
              </template>
            </div>
            <iron-collapse class="body-collapse" opened$="[[_isHot(alert.severity)]]" on-opened-changed="_sizeChanged" on-transitioning-changed="_sizeChanged">
              <div class="alert-body">
                <marked-element markdown="[[alert.body]]">
                  <div slot="markdown-html"></div>
                </marked-element>
              </div>
            </iron-collapse>
            </div>
          </div>
        </iron-collapse>
      </template>
    </dom-repeat>
  </template>

  <script>
    /**
     * `uvalib-alerts`
     * Manages the UX for Library Web Alerts
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibAlerts extends UvalibUiElement {
      static get is() { return 'uvalib-alerts'; }
      static get properties() {
        return Object.assign(super.properties,{
          _alerts: Array,
          _alertsSeen: Array,
          seenCount: {
            type: Number,
            notify: true
          }
        });
      }
      //Concat the this elements template with the parents
      static get template() {
        var parentTemplate = UvalibUiElement.template.cloneNode(true);
        var childTemplate = Polymer.DomModule.import('uvalib-alerts', 'template');
        parentTemplate.content.insertBefore(childTemplate.content,null);
        return parentTemplate;
      }
      _isHot(severity){
        return (severity==="alert1");
      }
      _toggleIt(e){
        e.currentTarget.parentElement.parentElement.querySelector('.body-collapse').toggle();
      }
      _dismissIt(e){
        var uuid = e.currentTarget.parentElement.parentElement.parentElement.uuid;
        this.$.alertsModel.setSeen(uuid);
      }
      unseeAll(){
        this.set('_alertsSeen',[]);
      }
      _sizeChanged(){
        this.dispatchEvent(new CustomEvent('size-changed', {detail: {height: this.clientHeight}}));
      }
    }

    window.customElements.define(UvalibAlerts.is, UvalibAlerts);
  </script>
</dom-module>
